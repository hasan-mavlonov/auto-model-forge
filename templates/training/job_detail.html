{# templates/training/job_detail.html - styled job status and training pipeline #}
{% extends "base.html" %}
{% load static %}

{% block title %}Training job {{ job.project_name }} · Auto Model Forge{% endblock %}

{% block content %}
  <section class="section" style="margin-bottom: 2.5rem;">
    <div class="card" style="padding: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div>
          <p class="pill" style="margin: 0;">Job ID: {{ job.public_id }}</p>
          <h1 style="margin: 0.65rem 0 0.35rem;">{{ job.project_name }}</h1>
          <p class="subtext">Keep this page open—status updates and downloads appear here.</p>
        </div>
        {% with job.status as status %}
          {% if status == "completed" %}
            <div class="status-badge status-completed">Completed</div>
          {% elif status == "processing" %}
            <div class="status-badge status-paid">Training in progress</div>
          {% elif status == "created" %}
            <div class="status-badge status-awaiting">Queued</div>
          {% else %}
            <div class="status-badge status-other">{{ job.get_status_display }}</div>
          {% endif %}
        {% endwith %}
      </div>

      <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top: 1rem;">
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Model type</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.model_type.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Base model</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.base_model.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Images</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.num_images }}</div>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem; padding: 1rem; background: var(--panel-strong);">
        <div class="subtext">Estimated price</div>
        <div style="font-weight: 800; font-size: 1.4rem; margin: 0.2rem 0;">${{ price_usd|floatformat:2 }} <span class="muted">(≈ ¥{{ price_cny|floatformat:2 }})</span></div>
        <p class="subtext" style="margin: 0;">Training starts immediately after you submit your dataset—no payment steps required.</p>
      </div>

      <div style="margin-top: 1rem; display: flex; gap: 0.65rem; flex-wrap: wrap;">
        <a href="{% url 'training:job_list' %}" class="btn-secondary">Back to your jobs</a>
        <a href="{% url 'training:job_images_download' job.public_id %}" class="btn-secondary">Download training images</a>
      </div>
    </div>
  </section>

  <section class="section" style="margin-top: -1rem;">
    <div class="card" style="padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid rgba(59,130,246,0.35); background: rgba(59,130,246,0.12);">
      <h2 style="margin: 0 0 0.35rem;">Training pipeline</h2>
      <p class="subtext" style="max-width: 780px;">Your dataset is queued and training starts automatically. We will deliver the trained model once the run completes.</p>
      <ul style="padding-left: 1.2rem; color: var(--muted); line-height: 1.5; margin: 0.75rem 0 0;">
        <li>Upload → preprocessing → training → artifact collection.</li>
        <li>Keep this tab open to grab the download link when ready.</li>
        <li>If you need to update images, start a new job with the latest dataset.</li>
      </ul>
    </div>
  </section>

  {% if user.is_staff %}
    <section class="section" style="margin-top: 1rem;">
      <div class="card" style="padding: 1.25rem;">
        <div style="display: flex; justify-content: space-between; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <div>
            <h3 style="margin: 0 0 0.3rem;">Admin tools</h3>
            <p class="subtext" style="margin: 0;">Uploaded images are visible below. Attach a trained model so the user can download it.</p>
          </div>
          <span class="pill">{{ job.images.count }} images</span>
        </div>

        {% if job.images.all %}
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
            {% for image in job.images.all %}
              <div class="card" style="padding: 0.35rem; background: rgba(255,255,255,0.02);">
                <img src="{{ image.image.url }}" alt="Training image {{ forloop.counter }}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 0.5rem;">
                <p class="subtext" style="margin: 0.35rem 0 0; word-break: break-word;">{{ image.original_filename|default:"Uploaded image" }}</p>
              </div>
            {% empty %}
              <p class="subtext">No images uploaded for this job.</p>
            {% endfor %}
          </div>
        {% endif %}

        {% if artifact_form %}
          <hr style="margin: 1.2rem 0; border-color: rgba(255,255,255,0.06);">
          <h4 style="margin: 0 0 0.5rem;">Upload trained model</h4>
          <form method="post" enctype="multipart/form-data" class="stack" style="gap: 0.6rem;">
            {% csrf_token %}
            <div>
              <label for="id_file" style="font-weight: 600;">Model file (optional)</label>
              {{ artifact_form.file }}
              {% if artifact_form.file.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.file.errors|striptags }}</div>
              {% endif %}
            </div>
            <div>
              <label for="id_download_url" style="font-weight: 600;">Download URL (optional)</label>
              {{ artifact_form.download_url }}
              <p class="subtext" style="margin: 0.15rem 0 0;">Provide a direct link if hosting externally (e.g., HF, Drive).</p>
              {% if artifact_form.download_url.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.download_url.errors|striptags }}</div>
              {% endif %}
            </div>
            <div>
              <label for="id_size_mb" style="font-weight: 600;">Size (MB, optional)</label>
              {{ artifact_form.size_mb }}
              {% if artifact_form.size_mb.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.size_mb.errors|striptags }}</div>
              {% endif %}
            </div>

            {% if artifact_form.non_field_errors %}
              <div class="message error">{{ artifact_form.non_field_errors|striptags }}</div>
            {% endif %}

            <button type="submit" class="btn-primary" style="align-self: flex-start;">Save artifact &amp; mark completed</button>
          </form>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if countdown_seconds is not None %}
    <section class="section" style="margin-top: 1.2rem;">
      <div class="card" style="padding: 1.25rem;">
        <p style="margin: 0 0 0.35rem; font-weight: 700;">Training deadline: {{ job.deadline_at }}</p>
        <p class="subtext" style="margin: 0 0 0.5rem;">Time left for delivering your model:</p>
        <div style="font-size: 1.3rem; font-weight: 800;" id="countdown"></div>
      </div>
    </section>

    <script>
      (function() {
        const el = document.getElementById("countdown");
        let remaining = Number("{{ countdown_seconds|default_if_none:0 }}");

        if (!el || !Number.isFinite(remaining) || remaining < 0) {
          if (el) {
            el.textContent = "00:00:00";
          }
          return;
        }

        function tick() {
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;

          el.textContent =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0");

          remaining -= 1;
          if (remaining >= 0) {
            setTimeout(tick, 1000);
          }
        }

        tick();
      })();
    </script>
  {% endif %}

  {% if job.status == "completed" and job.artifact %}
    <section class="section" style="margin-top: 1rem;">
      <div class="card" style="padding: 1.25rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h3 style="margin: 0 0 0.35rem;">Your model is ready</h3>
          <p class="subtext" style="margin: 0;">Download the trained artifact below.</p>
        </div>
        <div>
          {% if job.artifact.download_url %}
            <a href="{{ job.artifact.download_url }}" target="_blank" class="btn-primary">Download model</a>
          {% elif job.artifact.file %}
            <a href="{{ job.artifact.file.url }}" target="_blank" class="btn-primary">Download model</a>
          {% endif %}
        </div>
      </div>
    </section>
  {% endif %}
{% endblock %}
{% block extra_js %}{% endblock %}
