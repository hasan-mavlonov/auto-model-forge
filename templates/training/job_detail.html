{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Training job: {{ job.project_name }}</h1>

  <p><strong>ID:</strong> {{ job.public_id }}</p>
  <p><strong>Status:</strong> {{ job.get_status_display }}</p>
  <p><strong>Model type:</strong> {{ job.model_type.name }}</p>
  <p><strong>Base model:</strong> {{ job.base_model.name }}</p>
  <p><strong>Images:</strong> {{ job.num_images }}</p>
  <p><strong>Total price:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>

    {% if job.status == "awaiting_payment" %}
    <h2>Payment required</h2>
    <p style="max-width: 640px;">
      Payments are handled manually right now. Please include the reference
      <code>AMF-{{ job.public_id }}</code> in your payment note so we can match it
      quickly. Training starts as soon as we verify the transfer, and delivery is
      within <strong>24 hours</strong> after confirmation.
    </p>

    <div class="pay-grid">
      <div class="pay-card">
        <h3>Pay with WeChat</h3>
        <img
          src="{% static 'pay/wechat_qr.JPG' %}"
          alt="WeChat Pay QR"
          class="pay-qr"
        >
        <p>Open <strong>WeChat</strong> and scan this code to send your payment.</p>
        <p><strong>Send:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>
        <p><strong>Payment note:</strong> <code>AMF-{{ job.public_id }}</code></p>
        <p class="text-sm" style="color: #4b5563;">We verify payments against this note and start training immediately.</p>
      </div>

      <div class="pay-card">
        <h3>Pay with Alipay</h3>
        <img
          src="{% static 'pay/alipay_qr.JPG' %}"
          alt="Alipay QR"
          class="pay-qr"
        >
        <p>Open <strong>Alipay</strong> and scan this code to send your payment.</p>
        <p><strong>Send:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>
        <p><strong>Payment note:</strong> <code>AMF-{{ job.public_id }}</code></p>
        <p class="text-sm" style="color: #4b5563;">We verify payments against this note and start training immediately.</p>
      </div>
    </div>

    <div class="pay-card" style="background: #f9fafb; border-style: dashed;">
      <h3 style="margin-top: 0;">What happens next</h3>
      <ul style="padding-left: 1.2rem; color: #374151;">
        <li>We match your transfer using the note <code>AMF-{{ job.public_id }}</code>.</li>
        <li>Once confirmed, your training job moves to processing automatically.</li>
        <li>Delivery is guaranteed within <strong>24 hours</strong> after confirmation.</li>
      </ul>
    </div>
  {% endif %}



  {% if countdown_seconds is not None %}
    <p><strong>Training deadline:</strong> {{ job.deadline_at }}</p>
    <p>Time left for delivering your model:
      <span id="countdown"></span>
    </p>

    <script>
      (function() {
        const el = document.getElementById("countdown");
        let remaining = Number("{{ countdown_seconds|default_if_none:0 }}");

        if (!el || !Number.isFinite(remaining) || remaining < 0) {
          if (el) {
            el.textContent = "00:00:00";
          }
          return;
        }

        function tick() {
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;

          el.textContent =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0");

          remaining -= 1;
          if (remaining >= 0) {
            setTimeout(tick, 1000);
          }
        }

        tick();
      })();
    </script>
  {% endif %}

  {% if job.status == "completed" and job.artifact %}
    <p>Your model is ready:</p>
    {% if job.artifact.download_url %}
      <a href="{{ job.artifact.download_url }}" target="_blank">Download model</a>
    {% elif job.artifact.file %}
      <a href="{{ job.artifact.file.url }}" target="_blank">Download model</a>
    {% endif %}
  {% endif %}
{% endblock %}
