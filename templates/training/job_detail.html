{# templates/training/job_detail.html - styled job status and payment cards #}
{% extends "base.html" %}
{% load static %}

{% block title %}Training job {{ job.project_name }} · Auto Model Forge{% endblock %}

{% block content %}
  <section class="section" style="margin-bottom: 2.5rem;">
    <div class="card" style="padding: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div>
          <p class="pill" style="margin: 0;">Job ID: {{ job.public_id }}</p>
          <h1 style="margin: 0.65rem 0 0.35rem;">{{ job.project_name }}</h1>
          <p class="subtext">Keep this page open—status and payment instructions update here.</p>
        </div>
        <div class="badge">{{ job.get_status_display }}</div>
      </div>

      <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top: 1rem;">
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Model type</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.model_type.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Base model</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.base_model.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Images</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.num_images }}</div>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem; padding: 1rem; background: var(--panel-strong);">
        <div class="subtext">Total price</div>
        <div style="font-weight: 800; font-size: 1.4rem; margin: 0.2rem 0;">${{ price_usd|floatformat:2 }} <span class="muted">(≈ ¥{{ price_cny|floatformat:2 }})</span></div>
      </div>
    </div>
  </section>

  {% if job.status == "awaiting_payment" %}
    <section class="section" style="margin-top: -1rem;">
      <div class="card" style="padding: 1.5rem; margin-bottom: 1.25rem; background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(56,189,248,0.12)); border: 1px solid rgba(255,255,255,0.14);">
        <h2 style="margin: 0 0 0.35rem;">Payment required</h2>
        <p class="subtext" style="max-width: 780px;">Scan a QR below and include the note <code>AMF-{{ job.public_id }}</code>. We match your transfer and start training immediately. Delivery is typically within <strong>24 hours</strong> after confirmation.</p>
      </div>

      <div class="pay-grid">
        <div class="pay-card" style="background: var(--panel-strong);">
          <h3>Pay with WeChat</h3>
          <img
            src="{% static 'pay/wechat_qr.JPG' %}"
            alt="WeChat Pay QR"
            class="pay-qr"
          >
          <p>Open <strong>WeChat</strong> and scan to send your payment.</p>
          <p><strong>Send:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>
          <p><strong>Payment note:</strong> <code>AMF-{{ job.public_id }}</code></p>
          <p class="muted">We verify payments against this note and start training immediately.</p>
        </div>

        <div class="pay-card" style="background: var(--panel-strong);">
          <h3>Pay with Alipay</h3>
          <img
            src="{% static 'pay/alipay_qr.JPG' %}"
            alt="Alipay QR"
            class="pay-qr"
          >
          <p>Open <strong>Alipay</strong> and scan to send your payment.</p>
          <p><strong>Send:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>
          <p><strong>Payment note:</strong> <code>AMF-{{ job.public_id }}</code></p>
          <p class="muted">We verify payments against this note and start training immediately.</p>
        </div>
      </div>

      <div class="pay-card" style="background: rgba(255,255,255,0.03); border-style: dashed;">
        <h3 style="margin-top: 0;">What happens next</h3>
        <ul style="padding-left: 1.2rem; color: var(--muted); line-height: 1.5;">
          <li>We match your transfer using the note <code>AMF-{{ job.public_id }}</code>.</li>
          <li>Once confirmed, your training job moves to processing automatically.</li>
          <li>Delivery is guaranteed within <strong>24 hours</strong> after confirmation.</li>
        </ul>
      </div>
    </section>
  {% endif %}

  {% if countdown_seconds is not None %}
    <section class="section" style="margin-top: 1.2rem;">
      <div class="card" style="padding: 1.25rem;">
        <p style="margin: 0 0 0.35rem; font-weight: 700;">Training deadline: {{ job.deadline_at }}</p>
        <p class="subtext" style="margin: 0 0 0.5rem;">Time left for delivering your model:</p>
        <div style="font-size: 1.3rem; font-weight: 800;" id="countdown"></div>
      </div>
    </section>

    <script>
      (function() {
        const el = document.getElementById("countdown");
        let remaining = Number("{{ countdown_seconds|default_if_none:0 }}");

        if (!el || !Number.isFinite(remaining) || remaining < 0) {
          if (el) {
            el.textContent = "00:00:00";
          }
          return;
        }

        function tick() {
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;

          el.textContent =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0");

          remaining -= 1;
          if (remaining >= 0) {
            setTimeout(tick, 1000);
          }
        }

        tick();
      })();
    </script>
  {% endif %}

  {% if job.status == "completed" and job.artifact %}
    <section class="section" style="margin-top: 1rem;">
      <div class="card" style="padding: 1.25rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h3 style="margin: 0 0 0.35rem;">Your model is ready</h3>
          <p class="subtext" style="margin: 0;">Download the trained artifact below.</p>
        </div>
        <div>
          {% if job.artifact.download_url %}
            <a href="{{ job.artifact.download_url }}" target="_blank" class="btn-primary">Download model</a>
          {% elif job.artifact.file %}
            <a href="{{ job.artifact.file.url }}" target="_blank" class="btn-primary">Download model</a>
          {% endif %}
        </div>
      </div>
    </section>
  {% endif %}
{% endblock %}
