{% extends "base.html" %}
{% load static %}

{% block content %}
  <h1>Training job: {{ job.project_name }}</h1>

  <p><strong>ID:</strong> {{ job.public_id }}</p>
  <p><strong>Status:</strong> {{ job.get_status_display }}</p>
  <p><strong>Model type:</strong> {{ job.model_type.name }}</p>
  <p><strong>Base model:</strong> {{ job.base_model.name }}</p>
  <p><strong>Images:</strong> {{ job.num_images }}</p>
  <p><strong>Total price:</strong> ${{ job.total_price }}</p>

    {% if job.status == "awaiting_payment" %}
    <h2>Payment required</h2>
    <p>
      To start training, please send a payment of
      <strong>${{ job.total_price }}</strong>.
    </p>

    <div class="pay-grid">
      <div class="pay-card">
        <h3>Pay with WeChat</h3>
        <img
          src="{% static 'pay/wechat_qr.JPG' %}"
          alt="WeChat Pay QR"
          class="pay-qr"
        >
        <p>1. Open <strong>WeChat</strong> and scan this QR code.</p>
        <p>2. Send <strong>{{ job.total_price }} USD</strong> (or equivalent in CNY).</p>
        <p>3. In the comment / note, please write:<br>
          <code>AMF-{{ job.public_id }}</code>
        </p>
      </div>

      <div class="pay-card">
        <h3>Pay with Alipay</h3>
        <img
          src="{% static 'pay/alipay_qr.JPG' %}"
          alt="Alipay QR"
          class="pay-qr"
        >
        <p>1. Open <strong>Alipay</strong> and scan this QR code.</p>
        <p>2. Send <strong>{{ job.total_price }} USD</strong> (or equivalent in CNY).</p>
        <p>3. In the comment / note, please write:<br>
          <code>AMF-{{ job.public_id }}</code>
        </p>
      </div>
    </div>

    <p style="max-width: 520px;">
      After you complete the payment, we will manually verify it using the note
      <code>AMF-{{ job.public_id }}</code> and start training your model.
      You will receive your model within <strong>24 hours</strong> after payment
      confirmation.
    </p>
  {% endif %}



  {% if countdown_seconds %}
    <p><strong>Training deadline:</strong> {{ job.deadline_at }}</p>
    <p>Time left for delivering your model:
      <span id="countdown"></span>
    </p>

    <script>
      (function() {
        let remaining = {{ countdown_seconds|default:0 }};
        const el = document.getElementById("countdown");
        if (!el) return;

        function tick() {
          if (remaining < 0) return;
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;

          el.textContent =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0");

          remaining -= 1;
          if (remaining >= 0) {
            setTimeout(tick, 1000);
          }
        }

        tick();
      })();
    </script>
  {% endif %}

  {% if job.status == "completed" and job.artifact %}
    <p>Your model is ready:</p>
    {% if job.artifact.download_url %}
      <a href="{{ job.artifact.download_url }}" target="_blank">Download model</a>
    {% elif job.artifact.file %}
      <a href="{{ job.artifact.file.url }}" target="_blank">Download model</a>
    {% endif %}
  {% endif %}
{% endblock %}
