{# templates/training/job_detail.html - styled job status and payment cards #}
{% extends "base.html" %}
{% load static %}

{% block title %}Training job {{ job.project_name }} · Auto Model Forge{% endblock %}

{% block content %}
  <section class="section" style="margin-bottom: 2.5rem;">
    <div class="card" style="padding: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
        <div>
          <p class="pill" style="margin: 0;">Job ID: {{ job.public_id }}</p>
          <h1 style="margin: 0.65rem 0 0.35rem;">{{ job.project_name }}</h1>
          <p class="subtext">Keep this page open—status and payment instructions update here.</p>
        </div>
        {% with job.status as status %}
          {% if status == "completed" %}
            <div class="status-badge status-completed">Completed</div>
          {% elif status == "paid" or status == "processing" %}
            <div class="status-badge status-paid">Payment confirmed</div>
          {% elif status == "payment_submitted" %}
            <div class="status-badge status-submitted">Awaiting confirmation</div>
          {% elif status == "awaiting_payment" or status == "created" %}
            <div class="status-badge status-awaiting">Awaiting payment</div>
          {% else %}
            <div class="status-badge status-other">{{ job.get_status_display }}</div>
          {% endif %}
        {% endwith %}
      </div>

      <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top: 1rem;">
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Model type</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.model_type.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Base model</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.base_model.name }}</div>
        </div>
        <div class="card" style="padding: 1rem;">
          <div class="subtext">Images</div>
          <div style="font-weight: 700; margin-top: 0.2rem;">{{ job.num_images }}</div>
        </div>
      </div>

      <div class="card" style="margin-top: 1rem; padding: 1rem; background: var(--panel-strong);">
        <div class="subtext">Total price</div>
        <div style="font-weight: 800; font-size: 1.4rem; margin: 0.2rem 0;">${{ price_usd|floatformat:2 }} <span class="muted">(≈ ¥{{ price_cny|floatformat:2 }})</span></div>
      </div>

      <div style="margin-top: 1rem; display: flex; gap: 0.65rem; flex-wrap: wrap;">
        <a href="{% url 'training:job_list' %}" class="btn-secondary">Back to your jobs</a>
      </div>
    </div>
  </section>

  <section class="section" style="margin-top: -1rem;">
    {% if job.status == "awaiting_payment" or job.status == "created" %}
      <div class="card" style="padding: 1.5rem; margin-bottom: 1.25rem; background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(56,189,248,0.12)); border: 1px solid rgba(255,255,255,0.14);">
        <h2 style="margin: 0 0 0.35rem;">Awaiting payment</h2>
        <p class="subtext" style="max-width: 780px;">Scan the QR below via Alipay and include the note <code>AMF-{{ job.public_id }}</code>. Once you finish payment, click “I have paid” so we can verify and start training.</p>
      </div>
    {% elif payment_submitted %}
      <div class="card" style="padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid rgba(59,130,246,0.35); background: rgba(59,130,246,0.12);">
        <h2 style="margin: 0 0 0.35rem;">Payment submitted</h2>
        <p class="subtext" style="max-width: 780px;">We received your payment submission. We will verify it and start training soon.</p>
      </div>
    {% elif job.status == "paid" or job.status == "processing" %}
      <div class="card" style="padding: 1.5rem; margin-bottom: 1.25rem; border: 1px solid rgba(52,211,153,0.35); background: rgba(52,211,153,0.14);">
        <h2 style="margin: 0 0 0.35rem;">Payment confirmed</h2>
        <p class="subtext" style="max-width: 780px;">We confirmed your payment and queued training. We’ll deliver your model within 24 hours.</p>
      </div>
    {% endif %}

    {% if job.status == "awaiting_payment" or job.status == "created" or job.status == "payment_submitted" %}
      <div class="pay-grid">
        <div class="pay-card" style="background: var(--panel-strong);">
          <h3>Pay with Alipay</h3>
          <button class="pay-qr" data-qr-src="{% static 'pay/alipay_qr.jpg' %}" style="border: none; background: transparent; padding: 0; cursor: zoom-in;">
            <img
              src="{% static 'pay/alipay_qr.jpg' %}"
              alt="Alipay QR"
              style="width: 100%; height: 100%; object-fit: contain; border-radius: 0.75rem;"
            >
          </button>
          <p>Open <strong>Alipay</strong> and scan to send your payment.</p>
          <p><strong>Send:</strong> ${{ price_usd|floatformat:2 }} (≈ ¥{{ price_cny|floatformat:2 }})</p>
          <p><strong>Payment note:</strong> <code>AMF-{{ job.public_id }}</code></p>
          <p class="muted">Tap the QR to enlarge. We verify payments against this note and start training immediately.</p>
        </div>
      </div>

      {% if show_submit_payment %}
        <div class="card" style="padding: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
          <div>
            <h3 style="margin: 0 0 0.35rem;">Already paid?</h3>
            <p class="subtext" style="margin: 0;">Tap the button below so we can verify your transfer and start the 24h countdown.</p>
          </div>
          <form method="post" action="{% url 'training:job_submit_payment' job.public_id %}">
            {% csrf_token %}
            <button type="submit" class="btn-primary">I have paid — submit payment</button>
          </form>
        </div>
      {% endif %}

      <div class="pay-card" style="background: rgba(255,255,255,0.03); border-style: dashed;">
        <h3 style="margin-top: 0;">What happens next</h3>
        <ul style="padding-left: 1.2rem; color: var(--muted); line-height: 1.5;">
          <li>We match your transfer using the note <code>AMF-{{ job.public_id }}</code>.</li>
          <li>Click “I have paid” so our team can verify and move your job forward.</li>
          <li>Once confirmed, training starts and the 24h timer begins.</li>
        </ul>
      </div>
    {% endif %}
  </section>

  {% if user.is_staff %}
    <section class="section" style="margin-top: 1rem;">
      <div class="card" style="padding: 1.25rem;">
        <div style="display: flex; justify-content: space-between; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <div>
            <h3 style="margin: 0 0 0.3rem;">Admin tools</h3>
            <p class="subtext" style="margin: 0;">Uploaded images are visible below. Attach a trained model so the user can download it.</p>
          </div>
          <span class="pill">{{ job.images.count }} images</span>
        </div>

        {% if job.images.all %}
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
            {% for image in job.images.all %}
              <div class="card" style="padding: 0.35rem; background: rgba(255,255,255,0.02);">
                <img src="{{ image.image.url }}" alt="Training image {{ forloop.counter }}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 0.5rem;">
                <p class="subtext" style="margin: 0.35rem 0 0; word-break: break-word;">{{ image.original_filename|default:"Uploaded image" }}</p>
              </div>
            {% empty %}
              <p class="subtext">No images uploaded for this job.</p>
            {% endfor %}
          </div>
        {% endif %}

        {% if artifact_form %}
          <hr style="margin: 1.2rem 0; border-color: rgba(255,255,255,0.06);">
          <h4 style="margin: 0 0 0.5rem;">Upload trained model</h4>
          <form method="post" enctype="multipart/form-data" class="stack" style="gap: 0.6rem;">
            {% csrf_token %}
            <div>
              <label for="id_file" style="font-weight: 600;">Model file (optional)</label>
              {{ artifact_form.file }}
              {% if artifact_form.file.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.file.errors|striptags }}</div>
              {% endif %}
            </div>
            <div>
              <label for="id_download_url" style="font-weight: 600;">Download URL (optional)</label>
              {{ artifact_form.download_url }}
              <p class="subtext" style="margin: 0.15rem 0 0;">Provide a direct link if hosting externally (e.g., HF, Drive).</p>
              {% if artifact_form.download_url.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.download_url.errors|striptags }}</div>
              {% endif %}
            </div>
            <div>
              <label for="id_size_mb" style="font-weight: 600;">Size (MB, optional)</label>
              {{ artifact_form.size_mb }}
              {% if artifact_form.size_mb.errors %}
                <div class="message error" style="margin-top: 0.35rem;">{{ artifact_form.size_mb.errors|striptags }}</div>
              {% endif %}
            </div>

            {% if artifact_form.non_field_errors %}
              <div class="message error">{{ artifact_form.non_field_errors|striptags }}</div>
            {% endif %}

            <button type="submit" class="btn-primary" style="align-self: flex-start;">Save artifact &amp; mark completed</button>
          </form>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if countdown_seconds is not None %}
    <section class="section" style="margin-top: 1.2rem;">
      <div class="card" style="padding: 1.25rem;">
        <p style="margin: 0 0 0.35rem; font-weight: 700;">Training deadline: {{ job.deadline_at }}</p>
        <p class="subtext" style="margin: 0 0 0.5rem;">Time left for delivering your model:</p>
        <div style="font-size: 1.3rem; font-weight: 800;" id="countdown"></div>
      </div>
    </section>

    <script>
      (function() {
        const el = document.getElementById("countdown");
        let remaining = Number("{{ countdown_seconds|default_if_none:0 }}");

        if (!el || !Number.isFinite(remaining) || remaining < 0) {
          if (el) {
            el.textContent = "00:00:00";
          }
          return;
        }

        function tick() {
          const hours = Math.floor(remaining / 3600);
          const minutes = Math.floor((remaining % 3600) / 60);
          const seconds = remaining % 60;

          el.textContent =
            String(hours).padStart(2, "0") + ":" +
            String(minutes).padStart(2, "0") + ":" +
            String(seconds).padStart(2, "0");

          remaining -= 1;
          if (remaining >= 0) {
            setTimeout(tick, 1000);
          }
        }

        tick();
      })();
    </script>
  {% endif %}

  {% if job.status == "completed" and job.artifact %}
    <section class="section" style="margin-top: 1rem;">
      <div class="card" style="padding: 1.25rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h3 style="margin: 0 0 0.35rem;">Your model is ready</h3>
          <p class="subtext" style="margin: 0;">Download the trained artifact below.</p>
        </div>
        <div>
          {% if job.artifact.download_url %}
            <a href="{{ job.artifact.download_url }}" target="_blank" class="btn-primary">Download model</a>
          {% elif job.artifact.file %}
            <a href="{{ job.artifact.file.url }}" target="_blank" class="btn-primary">Download model</a>
          {% endif %}
        </div>
      </div>
    </section>
  {% endif %}

  <div class="qr-modal-backdrop" id="qrModal" aria-hidden="true">
    <div class="qr-modal">
      <button class="qr-modal-close" type="button" aria-label="Close">×</button>
      <img src="" alt="Payment QR code enlarged" id="qrModalImage">
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    (function() {
      const modal = document.getElementById("qrModal");
      const modalImg = document.getElementById("qrModalImage");
      const closeBtn = modal ? modal.querySelector(".qr-modal-close") : null;

      if (!modal || !modalImg) return;

      function openModal(src, alt) {
        modalImg.src = src;
        modalImg.alt = alt || "Payment QR code";
        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
      }

      modal.addEventListener("click", function (evt) {
        if (evt.target === modal) {
          closeModal();
        }
      });

      if (closeBtn) {
        closeBtn.addEventListener("click", closeModal);
      }

      document.querySelectorAll(".pay-qr").forEach(function(btn) {
        btn.addEventListener("click", function(evt) {
          evt.preventDefault();
          const src = btn.getAttribute("data-qr-src");
          const img = btn.querySelector("img");
          if (src) {
            openModal(src, img ? img.alt : "Payment QR code");
          } else if (img && img.src) {
            window.open(img.src, "_blank");
          }
        });
      });
    })();
  </script>
{% endblock %}
